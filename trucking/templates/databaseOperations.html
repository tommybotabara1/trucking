{% extends "includes/headerFooter.html" %}
{% load staticfiles%}

{% block content %}
    <title>Database Operations</title>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_code.jquery.com_jquery-3.3.1.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_1.10.19_js_jquery.dataTables.js' %}"></script>

    <style>
        div.dataTables_wrapper {
            margin: 0 auto;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="{% static 'css/datatables.min.css' %}"/>
    <script type="text/javascript" src="{% static 'js/http_cdn.datatables.net_v_dt_dt-1.10.18_b-1.5.4_datatables.js' %}"></script>
    <script src="{% static 'js/city.js' %}"></script>

    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_buttons_1.5.2_js_dataTables.buttons.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_buttons_1.5.2_js_buttons.flash.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdnjs.cloudflare.com_ajax_libs_jszip_3.1.3_jszip.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdnjs.cloudflare.com_ajax_libs_pdfmake_0.1.36_pdfmake.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdnjs.cloudflare.com_ajax_libs_pdfmake_0.1.36_vfs_fonts.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_buttons_1.5.2_js_buttons.html5.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_buttons_1.5.2_js_buttons.print.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'js/http_cdn.datatables.net_buttons_1.5.2_js_buttons.colVis.js' %}"></script>


    <section id="main-content">
      <section class="wrapper site-min-height">
        <div class="row">

          <!-- /col-lg-12 -->
          <div class="col-lg-12">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">Database Operations</li>
              </ol>
          </nav>
            <div class="row content-panel">
              <!-- /panel-heading -->
              <div class="panel-body">
                <div class="tab-content">
                {% if messages %}
                    <div class="alert alert-success alert-dismissable">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                        {% for message in messages %}
                            <strong>{{ message }}</strong>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if extra != none %}
                <div class="alert alert-danger alert-dismissable">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
                    <strong>{{ extra }}</strong>
                </div>
                {% endif %}
                  <div id="overview" class="tab-pane active">
                  <h2 class="centered">Database Operations</h2>
                  <hr>
                  <a class="btn btn-primary" href="{% url 'new_database_operation' %}" role="button">Create New Database Operations</a>
                  <a class="btn btn-primary" href="" role="button">Generate Statement Billing</a>
                  <button type="submit" class="btn btn-default" data-toggle="modal" data-target="#importDataModal">Import data</button>
                  <hr>
                      <table id="listTable" class="display nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>ID</th>
                                    <th>DATE</th>
                                    <th>CALL TIME</th>
                                    <th>PLATE NO.</th>
                                    <th>WB NO.</th>
                                    <th>ORIGIN</th>
                                    <th>DESTINATION</th>
                                    <th>DRIVER</th>
                                    <th>HELPER</th>
                                    <th>CUSTOMER</th>
                                    <th>CLIENT</th>
                                    <th>TRUCK TYPE</th>
                                    <th>QTY</th>
                                    <th>REMARKS</th>
                                    <th>DIESEL</th>
                                    <th>TRUCK BUDGET</th>
                                    <th>C/A HELPER</th>
                                    <th>TOLL FEE</th>
                                    <th>PARKING</th>
                                    <th>ENTRY FEE</th>
                                    <th>OTHERS</th>
                                    <th>TOTAL LIQ</th>
                                    <th>UNLIQ.</th>
                                    <th>DRIVER-SAL</th>
                                    <th>ADDITIONAL DRIVER SALARY</th>
                                    <th>HELPER-SAL</th>
                                    <th>ADDITIONAL HELPER SALARY</th>
                                    <th>BILLING</th>
                                    <th>ADD'L</th>
                                    <th>REVENUE</th>
                                    <th>BILLED DATE</th>
                                    <th>RECEIVED BY</th>
                                    <th>RECEIVED TIME</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for item in list %}
                             <tr>
                                <td>
                                    <div class="btn-group-justified btn-group-sm" role="group" aria-label="...">
                                        <a class="btn btn-success" href="{% url 'edit_database_operation' item.id "A" %}" role="button"><i class="fa fa-pencil"></i></a>
                                        <a class="btn btn-danger" href="{% url 'delete_database_operation' item.id %}" role="button"><i class="fa fa-trash"></i></a>
                                    </div>
                                </td>
                                <td>{{ item.id }}</td>
                                <td>{{ item.date|date:'m/d/Y'|default_if_none:"" }}</td>
                                <td>{{ item.calltime|time:'H:i'|default_if_none:"" }}</td>
                                <td>{{ item.plateno|default_if_none:"" }}</td>
                                <td>{{ item.wbno|default_if_none:"" }}</td>
                                <td>{{ item.origin|default_if_none:"" }}</td>
                                <td>{{ item.destination|default_if_none:"" }}</td>
                                <td>{{ item.driver.drivername|default_if_none:"" }}</td>
                                <td>{{ item.helper.helpername|default_if_none:"" }}</td>
                                <td>{{ item.customer.customername|default_if_none:"" }}</td>
                                <td>{{ item.client.clientname|default_if_none:"" }}</td>
                                <td>{{ item.trucktype|default_if_none:"" }}</td>
                                <td>{{ item.qty|default_if_none:"" }}</td>
                                <td>{{ item.remarks|default_if_none:"" }}</td>
                                <td>{{ item.diesel|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.truckbudget|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.cahelper|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.tollfee|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.parking|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.entryfee|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.others|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.totalliq|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.unliq|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.driversal|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.addldriversal|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.helpersal|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.addlhelpersal|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.billing|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.addl|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.revenue|default_if_none:""|floatformat:2 }}</td>
                                <td>{{ item.billeddate|date:'m/d/Y'|default_if_none:"" }}</td>
                                <td>{{ item.receivedby|default_if_none:"" }}</td>
                                <td>{{ item.receivedtime|time:'H:i'|default_if_none:"" }}</td>
                             </tr>
                            {% endfor %}
                            </tbody>
                      </table>
                  </div>
                    <!-- Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel">Modal title</h5>
                          </div>
                          <div id="modalBody" class="modal-body">
                            ...
                          </div>
                          <div class="modal-footer">
                            <a class="btn btn-round btn-success" id="modalEditButton" role="button">Edit</a>
                            <a class="btn btn-round btn-danger" id="modalDeleteButton" role="button">Delete</a>
                            <button type="button" class="btn btn-round" data-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="modal fade" id="importDataModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel">Import data (XLSX files only)</h5>
                          </div>
                          <div id="modalBody" class="modal-body">
                              Use this format: <a  href="{% static 'download/sample_xlsx.xlsx' %}" download> Download sample file </a>
                              <hr>

                              <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="file" name="file">
                          </div>
                          <div class="modal-footer">
                                    <button type="submit" class="btn btn-round btn-primary">Upload</button>
                              </form>
                            <button type="button" class="btn btn-round" data-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  <!-- /tab-pane -->
                </div>
                <!-- /tab-content -->
              </div>
              <!-- /panel-body -->
            </div>
            <!-- /col-lg-12 -->
          </div>
          <!-- /row -->
        </div>

          <!-- col-lg-12-->
        </div>
          </div>
          <!-- /col-lg-12 -->
          <!-- CUSTOM TOGGLES -->
        </div>
        <!-- /row -->
      </section>
      <!-- /wrapper -->
    </section>
    <script>
        let today = new Date();
        let time = '';
        let dd = today.getDate();
        let mm = today.getMonth() + 1; //January is 0!
        let yyyy = today.getFullYear();
        let hour    = today.getHours();
        let minute  = today.getMinutes();
        let second  = today.getSeconds();

        if (dd < 10) {
          dd = '0' + dd;
        }

        if (mm < 10) {
          mm = '0' + mm;
        }

        if(hour.toString().length == 1) {
         hour = '0'+hour;
        }
        if(minute.toString().length == 1) {
             minute = '0'+minute;
        }
        if(second.toString().length == 1) {
             second = '0'+second;
        }

        today = mm + '/' + dd + '/' + yyyy;
        time = hour+':'+minute+':'+second;
        $(document).ready(function() {
            $('#listTable').DataTable({
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                responsive: true,
                retrieve: true,
                paging: true,
                dom: 'Blfrtip',
                "scrollX": true,
                buttons: [
                    {
                        extend: 'copyHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    'colvis'
                ]
            });
        });

        var table;

        if ( $.fn.dataTable.isDataTable( '#listTable' ) ) {
            table = $('#listTable').DataTable();
        }
        else {
            table = $('#listTable').DataTable({
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                responsive: true,
                retrieve: true,
                paging: true,
                dom: 'Blfrtip',
                "scrollX": true,
                buttons: [
                    {
                        extend: 'copyHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Database Operations (exported: ' + today + ' ' + time + ')',
                        exportOptions: {
                            columns: ':visible',
                        }
                    },
                    'colvis'
                ]
            });
        }

        $('#listTable tbody').on( 'click', 'tr', function () {
            // alert( table.row( this ).data() );
            var modalBody = "<table class=\"table table-bordered\">";
            for(var i = 2; i <= 32 ; i++){
                modalBody += "<tr>";
                modalBody += "<td><b>"+ table.columns(i).header()[0].textContent +"</b></td>";
                modalBody += "<td>" + table.row(this).data()[i] + "</td>";
                modalBody += "</tr>";
            }
            modalBody += "</table>";
            $('#modalBody').html(modalBody);
            $('#modalLabel').html("DATABASE OPERATION  " + table.row(this).data()[1]);
            $('#modalEditButton').attr('href', '/database_operations/editDBO/' + table.row(this).data()[1]+"/A");
            $('#modalDeleteButton').attr('href', '/database_operations/deleteDBO/' + table.row(this).data()[1]);
            $('#exampleModal').modal();
        } );
    </script>
{% endblock %}